<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PokeQuant — Signals & Portfolio</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root { --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
    .hover-row:hover { background: #f9fafb; }
    .badge { border-radius: 0.25rem; padding: 0.15rem 0.4rem; }
    .badge-buy { background: #d1fae5; color: #065f46; }
    .badge-hold{ background: #e5e7eb; color: #374151; }
    .badge-sell{ background: #fee2e2; color: #991b1b; }
    .table-sticky thead th { position: sticky; top: 0; background: #f3f4f6; z-index: 1; }
    .zebra tbody tr:nth-child(odd) { background: #fcfcfd; }
    .btn { transition: transform .06s ease; }
    .btn:active { transform: translateY(1px); }
    .modal-open { overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold tracking-tight">PokeQuant — Signals & Portfolio</h1>
      <a class="text-sm underline" href="https://pokequant.jonathanbarreneche.workers.dev/health" target="_blank" rel="noreferrer">API Health</a>
    </header>

    <div id="status" class="hidden mb-3 p-2 border rounded bg-yellow-50 text-yellow-900"></div>

    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Email Alerts</h2>
      <form id="sub" class="flex flex-col sm:flex-row gap-2">
        <input id="email" type="email" placeholder="you@domain.com" class="border p-2 flex-1 rounded" required>
        <button class="btn bg-black text-white px-4 py-2 rounded">Subscribe</button>
      </form>
      <p class="text-sm text-gray-600 mt-1">We’ll email when a tracked card’s Buy/Hold/Sell signal changes.</p>
    </section>

    <section class="mb-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold mb-2">Cards</h2>
        <button id="btnReload" class="text-sm underline">Reload</button>
      </div>
      <p class="text-sm text-gray-600 mb-2">
        Tip: Click any row to copy its Card ID below (for adding a lot), or click to open details.
      </p>
      <div class="overflow-auto border rounded bg-white">
        <table class="min-w-full table-sticky zebra">
          <thead>
            <tr class="bg-gray-100 text-left text-sm">
              <th class="p-2">Card</th>
              <th class="p-2">Set</th>
              <th class="p-2">Rarity</th>
              <th class="p-2">Price</th>
              <th class="p-2">Signal</th>
              <th class="p-2">Score</th>
              <th class="p-2">Card ID</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <hr class="my-6">

    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Portfolio (MVP)</h2>

      <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
        <button id="btnCreate" class="btn bg-black text-white px-3 py-2 rounded">Create Portfolio</button>
        <input id="pid" class="border p-2 flex-1 rounded" placeholder="Portfolio ID"/>
        <input id="pkey" class="border p-2 flex-1 rounded" placeholder="Portfolio Secret"/>
        <button id="btnSaveCreds" class="btn border px-3 py-2 rounded">Save to Browser</button>
      </div>
      <p class="text-sm text-gray-600 mb-2">Your browser stores the ID/Secret in <em>localStorage</em>. Anyone with both can access the portfolio—keep them private.</p>

      <div class="flex flex-col lg:flex-row lg:items-center gap-2 mb-3">
        <input id="lotCard" class="border p-2 flex-1 rounded" placeholder="Card ID (click a row above to fill)"/>
        <input id="lotQty" class="border p-2 w-28 rounded" type="number" min="0" step="1" placeholder="Qty"/>
        <input id="lotCost" class="border p-2 w-40 rounded" type="number" min="0" step="0.01" placeholder="Cost USD"/>
        <input id="lotDate" class="border p-2 w-44 rounded" type="date"/>
        <button id="btnAddLot" class="btn bg-black text-white px-3 py-2 rounded">Add Lot</button>
        <button id="btnLoadPnL" class="btn border px-3 py-2 rounded">Load P&amp;L</button>
      </div>

      <div id="pnl" class="text-sm"></div>
    </section>
  </div>

  <!-- Card Details Modal -->
  <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white max-w-2xl w-full rounded shadow-lg p-4 relative">
      <button id="modalClose" class="absolute right-2 top-2 text-gray-500 hover:text-black" aria-label="Close">✕</button>
      <div class="flex gap-4">
        <img id="mImage" src="" alt="" class="w-32 h-auto rounded border">
        <div>
          <h3 id="mTitle" class="text-lg font-semibold"></h3>
          <div id="mMeta" class="text-sm text-gray-600"></div>
          <div class="mt-2">
            <a id="mCsv" href="#" class="text-sm underline" target="_blank" rel="noreferrer">Download CSV (last 120d)</a>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="flex items-baseline justify-between">
          <h4 class="font-semibold mb-1 text-sm">Price (USD if available)</h4>
          <div id="mPriceMeta" class="text-xs text-gray-500"></div>
        </div>
        <div id="mPriceSpark" class="w-full h-24 border rounded p-1 bg-gray-50"></div>
      </div>

      <div class="mt-4">
        <div class="flex items-baseline justify-between">
          <h4 class="font-semibold mb-1 text-sm">Score</h4>
          <div id="mScoreMeta" class="text-xs text-gray-500"></div>
        </div>
        <div id="mScoreSpark" class="w-full h-24 border rounded p-1 bg-gray-50"></div>
      </div>

      <div class="mt-5 border-t pt-3">
        <h4 class="font-semibold mb-2 text-sm">Watchlist — Price Alerts</h4>
        <div class="flex flex-col sm:flex-row gap-2 items-center">
          <input id="alertEmail" type="email" placeholder="you@domain.com" class="border p-2 rounded flex-1">
          <input id="alertPrice" type="number" min="0" step="0.01" placeholder="Price USD" class="border p-2 rounded w-40">
          <div class="flex gap-2">
            <button id="btnAlertAbove" class="btn border px-3 py-2 rounded text-xs">Alert if ≥</button>
            <button id="btnAlertBelow" class="btn border px-3 py-2 rounded text-xs">Alert if ≤</button>
          </div>
        </div>

        <div class="mt-3 grid gap-2 sm:grid-cols-3">
          <input id="manageAlertId" class="border p-2 rounded" placeholder="Alert ID">
          <input id="manageToken" class="border p-2 rounded" placeholder="Manage token">
          <button id="btnDeactivate" class="btn border px-3 py-2 rounded text-xs">Deactivate</button>
        </div>

        <div id="mAlertMsg" class="text-xs text-gray-600 mt-2"></div>
      </div>
    </div>
  </div>

  <script>
  const WORKER_BASE = "https://pokequant.jonathanbarreneche.workers.dev";

  const $ = sel => document.querySelector(sel);
  function setStatus(msg, kind='info') {
    const el = $('#status');
    if (!msg) { el.classList.add('hidden'); el.textContent = ''; return; }
    el.textContent = msg;
    el.classList.remove('hidden');
    el.className = 'mb-3 p-2 border rounded ' + (
      kind === 'error'
        ? 'bg-red-50 text-red-900 border-red-200'
        : kind === 'success'
          ? 'bg-green-50 text-green-900 border-green-200'
          : 'bg-yellow-50 text-yellow-900 border-yellow-200'
    );
    setTimeout(()=> setStatus(''), 3500);
  }
  function fmtUSD(x){ if(x==null||isNaN(Number(x)))return '—'; return '$'+Number(x).toFixed(2);}
  function fmtEUR(x){ if(x==null||isNaN(Number(x)))return '—'; return '€'+Number(x).toFixed(2);}
  function saveCreds(pid,pkey){ localStorage.setItem('pf_id',pid); localStorage.setItem('pf_key',pkey); $('#pid').value=pid; $('#pkey').value=pkey; }
  function loadCreds(){ const pid=localStorage.getItem('pf_id')||''; const pkey=localStorage.getItem('pf_key')||''; $('#pid').value=pid; $('#pkey').value=pkey; return {pid,pkey}; }
  function todayISO(){ return new Date().toISOString().slice(0,10); }

  async function fetchJSON(url, opts={}) { const r = await fetch(url, opts); if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); }

  async function loadCards() {
    try { const d = await fetchJSON(WORKER_BASE + '/api/cards'); if (Array.isArray(d) && d.length) return d; } catch(e){}
    const u = await fetchJSON(WORKER_BASE + '/api/universe');
    return (u || []).map(c => ({ ...c, signal: '—', score: '—' }));
  }

  function renderCards(data) {
    const tbody = $('#rows');
    if (!Array.isArray(data) || !data.length) {
      tbody.innerHTML = '<tr><td class="p-3 text-sm text-gray-600" colspan="7">No cards yet.</td></tr>';
      return;
    }
    const html = data.map(c => {
      const signal = (c.signal || '—').toString().toUpperCase();
      let badgeClass = 'badge-hold';
      if (signal === 'BUY') badgeClass = 'badge-buy';
      if (signal === 'SELL') badgeClass = 'badge-sell';
      const price = (c.price_usd != null) ? fmtUSD(c.price_usd) : (c.price_eur != null) ? fmtEUR(c.price_eur) : '—';
      const score = (c.score == null || c.score === '—') ? '—' : Number(c.score).toFixed(1);
      return `
        <tr class="hover-row cursor-pointer" data-cardid="${c.id}">
          <td class="p-2">
            <div class="flex gap-2 items-center">
              <img src="${c.image_url || ''}" alt="" class="w-12 h-auto rounded"/>
              <div><div class="font-medium">${c.name}</div></div>
            </div>
          </td>
          <td class="p-2">${c.set_name || ''}</td>
          <td class="p-2">${c.rarity || ''}</td>
          <td class="p-2">${price}</td>
          <td class="p-2"><span class="badge ${badgeClass}">${signal}</span></td>
          <td class="p-2">${score}</td>
          <td class="p-2 text-xs text-gray-600">${c.id}</td>
        </tr>`;
    }).join('');
    tbody.innerHTML = html;

    tbody.querySelectorAll('tr[data-cardid]').forEach(tr => {
      tr.addEventListener('click', () => {
        const id = tr.getAttribute('data-cardid');
        $('#lotCard').value = id || '';
        openDetails(id);
      });
    });
  }

  function sparklineSVG(values, { width=640, height=88, pad=8 } = {}) {
    if (!Array.isArray(values) || values.length < 2) {
      return `<div class="text-xs text-gray-500 p-2">Not enough data yet.</div>`;
    }
    const w=width,h=height,p=pad,n=values.length;
    let min = Math.min(...values.filter(Number.isFinite)), max = Math.max(...values.filter(Number.isFinite));
    if (!isFinite(min) || !isFinite(max)) return `<div class="text-xs text-gray-500 p-2">No numeric values.</div>`;
    if (max === min) { min -= 1; max += 1; }
    const rng=max-min;
    const xs = values.map((_,i)=> p + (i*(w-2*p))/(n-1));
    const ys = values.map(v=> (h-p) - ((v-min)/rng)*(h-2*p));
    const pts = xs.map((x,i)=>`${x.toFixed(2)},${ys[i].toFixed(2)}`).join(' ');
    const up = values[n-1] >= values[0];
    const stroke = up ? '#065f46' : '#991b1b';
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <rect x="0" y="0" width="${w}" height="${h}" fill="white"/>
      <polyline fill="none" stroke="${stroke}" stroke-width="2" points="${pts}"/>
      <circle cx="${xs[n-1].toFixed(2)}" cy="${ys[n-1].toFixed(2)}" r="2.5" fill="${stroke}"/>
    </svg>`;
  }

  let currentCardId = null;

  async function openDetails(cardId) {
    try {
      const data = await fetchJSON(WORKER_BASE + '/api/card?id=' + encodeURIComponent(cardId));
      if (!data?.ok) throw new Error('No data');

      currentCardId = cardId;

      $('#mImage').src = data.card?.image_url || '';
      $('#mTitle').textContent = `${data.card?.name || cardId}`;
      $('#mMeta').textContent = `${data.card?.set_name || ''} • ${data.card?.rarity || ''}`;
      $('#mCsv').href = WORKER_BASE + '/research/card-csv?id=' + encodeURIComponent(cardId) + '&days=120';

      const priceSeries = (data.prices || []).map(r => (r.usd != null ? Number(r.usd) : (r.eur != null ? Number(r.eur) : NaN))).filter(Number.isFinite);
      $('#mPriceSpark').innerHTML = sparklineSVG(priceSeries, { width: 640, height: 96, pad: 8 });
      const lastP = (data.prices || []).slice(-1)[0];
      const lastNum = lastP ? (lastP.usd != null ? Number(lastP.usd) : (lastP.eur != null ? Number(lastP.eur) : null)) : null;
      const lastLbl = lastP ? (lastP.usd != null ? fmtUSD(lastNum) : (lastNum!=null ? fmtEUR(lastNum) : '—')) : '—';
      $('#mPriceMeta').textContent = `${lastLbl} • ${priceSeries.length} pts`;

      const scores = (data.signals || []).map(r => r.score != null ? Number(r.score) : NaN).filter(Number.isFinite);
      $('#mScoreSpark').innerHTML = scores.length ? sparklineSVG(scores, { width: 640, height: 96, pad: 8 }) : '<div class="text-xs text-gray-500 p-2">No scores yet.</div>';
      $('#mScoreMeta').textContent = scores.length ? `${scores[scores.length-1].toFixed(1)} • ${scores.length} pts` : '';

      const m = $('#cardModal'); m.classList.remove('hidden'); m.classList.add('flex'); document.body.classList.add('modal-open');
      $('#mAlertMsg').textContent = '';
    } catch (e) { console.error(e); setStatus('Failed to load details: ' + e.message, 'error'); }
  }
  function closeModal(){ const m=$('#cardModal'); m.classList.add('hidden'); m.classList.remove('flex'); document.body.classList.remove('modal-open'); currentCardId=null; }

  document.addEventListener('DOMContentLoaded', () => {
    $('#lotDate').value = todayISO(); loadCreds();

    async function reloadCards(){ setStatus('Loading cards…'); try{ const d=await loadCards(); renderCards(d); setStatus('Cards loaded.','success'); }catch(e){ console.error(e); setStatus('Failed to load cards: '+e.message,'error'); } }
    $('#btnReload').addEventListener('click', reloadCards);

    $('#sub').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email=$('#email').value.trim(); if(!email) return;
      try{
        const r=await fetch(WORKER_BASE+'/api/subscribe',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({email})});
        if(!r.ok) throw new Error('HTTP '+r.status); setStatus('Subscribed! You’ll get an email when signals change.','success'); $('#email').value='';
      }catch(e){ setStatus('Subscription failed: '+e.message,'error'); }
    });

    $('#btnCreate').addEventListener('click', async ()=>{
      try{
        const r=await fetch(WORKER_BASE+'/portfolio/create',{method:'POST'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j=await r.json(); if(j.id && j.secret){ saveCreds(j.id,j.secret); setStatus('Portfolio created and saved to this browser.','success'); } else throw new Error('No id/secret returned.');
      }catch(e){ setStatus('Create portfolio failed: '+e.message,'error'); }
    });

    $('#btnSaveCreds').addEventListener('click', ()=>{
      const pid=$('#pid').value.trim(), pkey=$('#pkey').value.trim();
      if(!pid||!pkey){ setStatus('Enter both Portfolio ID and Secret.','error'); return; }
      saveCreds(pid,pkey); setStatus('Credentials saved to this browser.','success');
    });

    $('#btnAddLot').addEventListener('click', async ()=>{
      const pid=$('#pid').value.trim(), pkey=$('#pkey').value.trim();
      const card=$('#lotCard').value.trim(), qty=Number($('#lotQty').value), cost=Number($('#lotCost').value);
      const date=$('#lotDate').value || todayISO();
      if(!pid||!pkey) return setStatus('Save portfolio credentials first.','error');
      if(!card || !(qty>0) || !(cost>=0)) return setStatus('Invalid lot fields.','error');
      try{
        const r=await fetch(WORKER_BASE+'/portfolio/add-lot',{method:'POST',headers:{'content-type':'application/json','x-portfolio-id':pid,'x-portfolio-secret':pkey},body:JSON.stringify({card_id:card,qty,cost_usd:cost,acquired_at:date})});
        const j=await r.json(); if(!r.ok||!j.ok) throw new Error(j.error||('HTTP '+r.status));
        setStatus('Lot added.','success'); $('#btnLoadPnL').click();
      }catch(e){ setStatus('Add lot failed: '+e.message,'error'); }
    });

    $('#btnLoadPnL').addEventListener('click', async ()=>{
      const pid=$('#pid').value.trim(), pkey=$('#pkey').value.trim();
      if(!pid||!pkey) return setStatus('Save portfolio credentials first.','error');
      try{
        const r=await fetch(WORKER_BASE+'/portfolio',{headers:{'x-portfolio-id':pid,'x-portfolio-secret':pkey}});
        const j=await r.json(); if(!r.ok||!j.ok) throw new Error(j.error||('HTTP '+r.status));
        const rows=j.rows||[], t=j.totals||{};
        $('#pnl').innerHTML=`
          <div class="mb-2"><b>Totals:</b>
            Cost <b>${fmtUSD(t.cost_usd)}</b>, Mkt <b>${fmtUSD(t.market_value_usd)}</b>, P&L <b>${fmtUSD(t.pnl_usd)}</b>
            ${t.roi_pct!=null ? ' ('+Number(t.roi_pct).toFixed(2)+'%)' : '' }
          </div>
          <div class="overflow-auto border rounded bg-white">
            <table class="min-w-full">
              <thead><tr class="bg-gray-100 text-left text-sm">
                <th class="p-2">Card</th><th class="p-2">Qty</th><th class="p-2">Cost (USD)</th>
                <th class="p-2">Price</th><th class="p-2">Market Value (USD)</th><th class="p-2">P&L (USD)</th>
              </tr></thead>
              <tbody>
                ${rows.map(r=>`
                  <tr class="border-t">
                    <td class="p-2">
                      <div class="flex gap-2 items-center">
                        <img src="${r.image_url||''}" class="w-10 h-auto rounded"/>
                        <div><div class="font-medium">${r.name}</div><div class="text-gray-500 text-xs">${r.set_name||''}</div></div>
                      </div>
                    </td>
                    <td class="p-2">${r.qty ?? '—'}</td>
                    <td class="p-2">${fmtUSD(r.cost_usd)}</td>
                    <td class="p-2">${r.price_usd!=null?fmtUSD(r.price_usd):(r.price_eur!=null?fmtEUR(r.price_eur):'—')} <span class="text-gray-500 text-xs">${r.price_as_of||''}</span></td>
                    <td class="p-2">${r.market_value_usd!=null?fmtUSD(r.market_value_usd):'—'}</td>
                    <td class="p-2 ${r.pnl_usd>0?'text-green-700':(r.pnl_usd<0?'text-red-700':'')}">${r.pnl_usd!=null?fmtUSD(r.pnl_usd):'—'}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        setStatus('P&L updated.','success');
      }catch(e){ console.error(e); setStatus('Load P&L failed: '+e.message,'error'); }
    });

    $('#modalClose').addEventListener('click', closeModal);
    $('#cardModal').addEventListener('click', e => { if (e.target === $('#cardModal')) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // Watchlist alert creation
    async function createAlert(kind) {
      const email = $('#alertEmail').value.trim();
      const price = Number($('#alertPrice').value);
      if (!currentCardId) return;
      if (!email) { $('#mAlertMsg').textContent = 'Enter your email.'; return; }
      if (!(price > 0)) { $('#mAlertMsg').textContent = 'Enter a valid USD price.'; return; }
      try {
        const r = await fetch(WORKER_BASE + '/alerts/create', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ email, card_id: currentCardId, kind, threshold: price })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || ('HTTP ' + r.status));

        // Store id+token locally to make deactivation easy
        let store = {};
        try { store = JSON.parse(localStorage.getItem('alerts_tokens') || '{}'); } catch {}
        store[j.id] = j.manage_token;
        localStorage.setItem('alerts_tokens', JSON.stringify(store));

        // Pre-fill manage fields
        $('#manageAlertId').value = j.id;
        $('#manageToken').value   = j.manage_token;

        $('#mAlertMsg').textContent = 'Alert saved. Check your email for a manage link.';
        $('#alertPrice').value = '';
      } catch (e) {
        $('#mAlertMsg').textContent = 'Failed to save alert: ' + e.message;
      }
    }
    $('#btnAlertAbove').addEventListener('click', () => createAlert('price_above'));
    $('#btnAlertBelow').addEventListener('click', () => createAlert('price_below'));

    // Watchlist deactivation from UI
    $('#btnDeactivate').addEventListener('click', async () => {
      const id = $('#manageAlertId').value.trim();
      const token = $('#manageToken').value.trim();
      if (!id || !token) { $('#mAlertMsg').textContent = 'Enter Alert ID and Manage token.'; return; }
      try {
        const r = await fetch(WORKER_BASE + '/alerts/deactivate', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ id, token })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || ('HTTP ' + r.status));
        $('#mAlertMsg').textContent = 'Alert deactivated.';
      } catch (e) {
        $('#mAlertMsg').textContent = 'Failed to deactivate: ' + e.message;
      }
    });

    // First load
    (async () => { await reloadCards(); })();
  });

  async function reloadCards(){ setStatus('Loading cards…'); try{ const d=await loadCards(); renderCards(d); setStatus('Cards loaded.','success'); }catch(e){ console.error(e); setStatus('Failed to load cards: '+e.message,'error'); } }
  </script>
</body>
</html>
