<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PokeQuant — Signals & Portfolio</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .hover-row:hover { background: #f9fafb; }
    .badge { border-radius: 0.25rem; padding: 0.15rem 0.4rem; }
    .badge-buy { background: #d1fae5; color: #065f46; }
    .badge-hold{ background: #e5e7eb; color: #374151; }
    .badge-sell{ background: #fee2e2; color: #991b1b; }
    .card-tiny { border: 1px solid #eee; border-radius: 8px; padding: 8px; background:#fff; }
    .grid-auto { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
    @media (min-width:640px){ .grid-auto{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    @media (min-width:1024px){ .grid-auto{ grid-template-columns:repeat(6,minmax(0,1fr)); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">PokeQuant — Signals & Portfolio</h1>
      <a class="text-sm underline" href="https://pokequant.jonathanbarreneche.workers.dev/health" target="_blank" rel="noreferrer">API Health</a>
    </header>

    <div id="status" class="hidden mb-3 p-2 border rounded bg-yellow-50 text-yellow-900"></div>

    <!-- Email subscribe -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Email Alerts</h2>
      <form id="sub" class="flex flex-col sm:flex-row gap-2">
        <input id="email" type="email" placeholder="you@domain.com" class="border p-2 flex-1 rounded" required>
        <button class="bg-black text-white px-4 py-2 rounded">Subscribe</button>
      </form>
      <p class="text-sm text-gray-600 mt-1">We’ll email when a tracked card’s signal changes or your watch alerts fire.</p>
    </section>

    <!-- Movers -->
    <section class="mb-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Top Movers</h2>
        <button id="reloadMovers" class="text-sm underline">Reload</button>
      </div>
      <div id="movers" class="grid-auto"></div>
    </section>

    <!-- Losers -->
    <section class="mb-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Biggest Losers</h2>
      </div>
      <div id="losers" class="grid-auto"></div>
    </section>

    <!-- Discover / Search -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">Cards</h2>
      <div class="flex flex-col md:flex-row gap-2 mb-2 items-center">
        <input id="q" class="border p-2 rounded flex-1" placeholder="Search by name, set or id…">
        <select id="set" class="border p-2 rounded">
          <option value="">All sets</option>
        </select>
        <select id="rarity" class="border p-2 rounded">
          <option value="">All rarities</option>
          <option>Special illustration rare</option>
          <option>Illustration Rare</option>
          <option>Full Art</option>
          <option>Ultra Rare</option>
          <option>Promo</option>
          <option>Rare Secret</option>
          <option>Rare Rainbow</option>
        </select>
        <button id="btnReload" class="text-sm underline">Reload</button>
      </div>
      <div class="overflow-auto border rounded bg-white">
        <table class="min-w-full">
          <thead>
            <tr class="bg-gray-100 text-left text-sm">
              <th class="p-2">Card</th>
              <th class="p-2">Set</th>
              <th class="p-2">Rarity</th>
              <th class="p-2">Price</th>
              <th class="p-2">Signal</th>
              <th class="p-2">Score</th>
              <th class="p-2">Alert</th>
              <th class="p-2">Card ID</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Alert modal -->
  <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white max-w-md w-full rounded shadow-lg p-4 relative">
      <button id="alertClose" class="absolute right-2 top-2 text-gray-500 hover:text-black">✕</button>
      <h3 class="text-lg font-semibold mb-2">Create Price Alert</h3>
      <div class="space-y-2">
        <div class="text-sm text-gray-600">For card: <span id="alertCard" class="font-mono text-gray-900"></span></div>
        <input id="aEmail" class="border p-2 w-full rounded" placeholder="you@domain.com">
        <div class="flex gap-2">
          <select id="aKind" class="border p-2 rounded">
            <option value="price_below">Price ≤ threshold</option>
            <option value="price_above">Price ≥ threshold</option>
          </select>
          <input id="aThr" type="number" step="0.01" class="border p-2 rounded flex-1" placeholder="Threshold (USD)">
        </div>
        <button id="aSubmit" class="bg-black text-white px-4 py-2 rounded">Create alert</button>
      </div>
    </div>
  </div>

<script>
const WORKER_BASE = "https://pokequant.jonathanbarreneche.workers.dev";
const $ = s => document.querySelector(s);
function setStatus(msg, kind='info'){ const el=$('#status'); if(!msg){el.classList.add('hidden');el.textContent='';return;} el.textContent=msg; el.classList.remove('hidden'); el.className='mb-3 p-2 border rounded '+(kind==='error'?'bg-red-50 text-red-900 border-red-200':kind==='success'?'bg-green-50 text-green-900 border-green-200':'bg-yellow-50 text-yellow-900 border-yellow-200'); setTimeout(()=>setStatus(''),4000);}
function fmtUSD(x){ return (x==null||isNaN(Number(x)))?'—':'$'+Number(x).toFixed(2); }
function imgTag(url){ return url?`<img src="${url}" class="w-16 h-auto rounded"/>`:''; }

async function fetchJSON(u, opts){ const r=await fetch(u,opts); if(!r.ok) throw new Error(r.status); return r.json(); }

async function loadMovers(){
  try{
    const [up,down] = await Promise.all([
      fetchJSON(WORKER_BASE+'/api/movers?n=12'),
      fetchJSON(WORKER_BASE+'/api/movers?dir=down&n=12')
    ]);
    const m = $('#movers'); m.innerHTML = up.map(c=>tile(c)).join('');
    const l = $('#losers'); l.innerHTML = down.map(c=>tile(c)).join('');
  }catch(e){ console.error(e); setStatus('Failed to load movers/losers','error'); }
}
function tile(c){
  const price = (c.price_usd != null) ? fmtUSD(c.price_usd) : (c.price_eur != null ? '€'+Number(c.price_eur).toFixed(2) : '—');
  const signal = (c.signal||'—').toString().toUpperCase();
  let badge='badge-hold'; if(signal==='BUY') badge='badge-buy'; if(signal==='SELL') badge='badge-sell';
  return `<div class="card-tiny">
    <div class="flex gap-2">
      <img src="${c.image_url||''}" class="w-12 h-auto rounded"/>
      <div class="text-sm">
        <div class="font-medium leading-4">${c.name}</div>
        <div class="text-gray-500 text-xs">${c.set_name||''}</div>
      </div>
    </div>
    <div class="mt-2 flex items-center justify-between text-sm">
      <div>${price}</div>
      <div><span class="badge ${badge}">${signal}</span></div>
    </div>
  </div>`;
}

let UNIVERSE = [];
function unique(arr){ return Array.from(new Set(arr)); }
function buildSetOptions(){
  const sets = unique(UNIVERSE.map(c=>c.set_name).filter(Boolean)).sort();
  const sel = $('#set'); sel.innerHTML = '<option value="">All sets</option>' + sets.map(s=>`<option>${s}</option>`).join('');
}

function renderCards(data){
  const tbody = $('#rows');
  if(!Array.isArray(data)||!data.length){ tbody.innerHTML = '<tr><td class="p-3 text-sm text-gray-600" colspan="8">No cards.</td></tr>'; return; }
  tbody.innerHTML = data.map(c => {
    const price = (c.price_usd != null) ? fmtUSD(c.price_usd) : (c.price_eur != null ? '€'+Number(c.price_eur).toFixed(2) : '—');
    const signal = (c.signal||'—').toString().toUpperCase();
    let badge='badge-hold'; if(signal==='BUY') badge='badge-buy'; if(signal==='SELL') badge='badge-sell';
    return `<tr class="hover-row">
      <td class="p-2"><div class="flex gap-2 items-center"><img src="${c.image_url||''}" class="w-12 h-auto rounded"/><div><div class="font-medium">${c.name}</div></div></div></td>
      <td class="p-2">${c.set_name||''}</td>
      <td class="p-2">${c.rarity||''}</td>
      <td class="p-2">${price}</td>
      <td class="p-2"><span class="badge ${badge}">${signal}</span></td>
      <td class="p-2">${c.score!=null?Number(c.score).toFixed(1):'—'}</td>
      <td class="p-2"><button class="text-sm underline" data-alert="${c.id}">Set alert</button></td>
      <td class="p-2 text-xs text-gray-600">${c.id}</td>
    </tr>`;
  }).join('');

  tbody.querySelectorAll('button[data-alert]').forEach(btn=>{
    btn.addEventListener('click',()=>openAlert(btn.getAttribute('data-alert')));
  });
}

function filterCards(){
  const q = $('#q').value.toLowerCase();
  const set = $('#set').value;
  const rarity = $('#rarity').value;
  let list = UNIVERSE;
  if (q) list = list.filter(c => (c.name||'').toLowerCase().includes(q) || (c.set_name||'').toLowerCase().includes(q) || (c.id||'').toLowerCase().includes(q));
  if (set) list = list.filter(c => c.set_name === set);
  if (rarity) list = list.filter(c => (c.rarity||'').toLowerCase() === rarity.toLowerCase());
  renderCards(list);
}

async function loadUniverse(){
  setStatus('Loading cards…');
  try{
    // prefer cards with signals; fallback to universe
    let data = await fetchJSON(WORKER_BASE + '/api/cards');
    if(!Array.isArray(data) || !data.length) data = await fetchJSON(WORKER_BASE + '/api/universe');
    UNIVERSE = data;
    buildSetOptions();
    filterCards();
    setStatus('Cards loaded.','success');
  }catch(e){ console.error(e); setStatus('Failed to load cards','error'); }
}

function openAlert(cardId){
  $('#alertCard').textContent = cardId;
  $('#alertModal').classList.remove('hidden'); $('#alertModal').classList.add('flex');
}
$('#alertClose').addEventListener('click',()=>{ $('#alertModal').classList.add('hidden'); $('#alertModal').classList.remove('flex'); });
$('#aSubmit').addEventListener('click', async()=>{
  const email = $('#aEmail').value.trim();
  const kind = $('#aKind').value;
  const thr = Number($('#aThr').value);
  const card = $('#alertCard').textContent;
  if(!email || !card || !Number.isFinite(thr)) return setStatus('Fill email and numeric threshold','error');
  try{
    const r = await fetch(WORKER_BASE+'/alerts/create', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({email,kind,threshold:thr,card_id:card})});
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.error||('HTTP '+r.status));
    setStatus('Alert created. Check your email.','success');
    $('#alertClose').click();
  }catch(e){ setStatus('Create alert failed','error'); }
});

// Events
$('#btnReload').addEventListener('click', loadUniverse);
$('#reloadMovers').addEventListener('click', loadMovers);
['q','set','rarity'].forEach(id=>{ $('#'+id).addEventListener('input', filterCards); });

// Subscribe
$('#sub').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = $('#email').value.trim(); if(!email) return;
  try{
    const r = await fetch(WORKER_BASE+'/api/subscribe', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({email}) });
    if(!r.ok) throw new Error('HTTP '+r.status);
    setStatus('Subscribed!','success'); $('#email').value='';
  }catch(e){ setStatus('Subscription failed','error'); }
});

// Boot
loadMovers();
loadUniverse();
</script>
</body>
</html>
