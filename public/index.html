<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PokeQuant — Signals & Portfolio</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .hover-row:hover { background: #f9fafb; }
    .badge { border-radius: 0.25rem; padding: 0.15rem 0.4rem; }
    .badge-buy { background: #d1fae5; color: #065f46; }
    .badge-hold{ background: #e5e7eb; color: #374151; }
    .badge-sell{ background: #fee2e2; color: #991b1b; }
    .card-tile:hover { transform: translateY(-2px); transition: transform .12s ease; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">PokeQuant — Signals & Portfolio</h1>
      <a class="text-sm underline" href="https://pokequant.jonathanbarreneche.workers.dev/health" target="_blank" rel="noreferrer">API Health</a>
    </header>

    <div id="status" class="hidden mb-3 p-2 border rounded bg-yellow-50 text-yellow-900"></div>

    <!-- Subscribe -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Email Alerts</h2>
      <form id="sub" class="flex flex-col sm:flex-row gap-2">
        <input id="email" type="email" placeholder="you@domain.com" class="border p-2 flex-1 rounded" required>
        <button class="bg-black text-white px-4 py-2 rounded">Subscribe</button>
      </form>
      <p class="text-sm text-gray-600 mt-1">We’ll email when a tracked card’s Buy/Hold/Sell signal changes.</p>
    </section>

    <!-- TOP MOVERS -->
    <section class="mb-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold mb-2">Top Movers <span class="text-sm text-gray-500">(7‑day price momentum)</span></h2>
        <button id="btnReload" class="text-sm underline">Reload</button>
      </div>
      <div id="movers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
      <p id="moversEmpty" class="text-sm text-gray-600 mt-2 hidden">No movers yet. They’ll appear once signals are computed.</p>
    </section>

    <!-- Cards table -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">Cards</h2>
      <p class="text-sm text-gray-600 mb-2">Tip: Click any row to copy its Card ID below (for adding a lot), or click a tile/row to open details.</p>
      <div class="overflow-auto border rounded bg-white">
        <table class="min-w-full">
          <thead>
            <tr class="bg-gray-100 text-left text-sm">
              <th class="p-2">Card</th>
              <th class="p-2">Set</th>
              <th class="p-2">Rarity</th>
              <th class="p-2">Price</th>
              <th class="p-2">Signal</th>
              <th class="p-2">Score</th>
              <th class="p-2">Card ID</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <hr class="my-6">

    <!-- Portfolio -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Portfolio (MVP)</h2>

      <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
        <button id="btnCreate" class="bg-black text-white px-3 py-2 rounded">Create Portfolio</button>
        <input id="pid" class="border p-2 flex-1 rounded" placeholder="Portfolio ID"/>
        <input id="pkey" class="border p-2 flex-1 rounded" placeholder="Portfolio Secret"/>
        <button id="btnSaveCreds" class="border px-3 py-2 rounded">Save to Browser</button>
      </div>
      <p class="text-sm text-gray-600 mb-2">Your browser stores the ID/Secret in <em>localStorage</em>. Anyone with both can access the portfolio—keep them private.</p>

      <div class="flex flex-col lg:flex-row lg:items-center gap-2 mb-3">
        <input id="lotCard" class="border p-2 flex-1 rounded" placeholder="Card ID (click a row above to fill)"/>
        <input id="lotQty" class="border p-2 w-28 rounded" type="number" min="0" step="1" placeholder="Qty"/>
        <input id="lotCost" class="border p-2 w-40 rounded" type="number" min="0" step="0.01" placeholder="Cost USD"/>
        <input id="lotDate" class="border p-2 w-44 rounded" type="date"/>
        <button id="btnAddLot" class="bg-black text-white px-3 py-2 rounded">Add Lot</button>
        <button id="btnLoadPnL" class="border px-3 py-2 rounded">Load P&amp;L</button>
      </div>

      <div id="pnl" class="text-sm"></div>
    </section>
  </div>

  <script>
    const WORKER_BASE = "https://pokequant.jonathanbarreneche.workers.dev";

    const $ = sel => document.querySelector(sel);
    function setStatus(msg, kind='info') {
      const el = $('#status');
      if (!msg) { el.classList.add('hidden'); el.textContent = ''; return; }
      el.textContent = msg;
      el.classList.remove('hidden');
      el.className = 'mb-3 p-2 border rounded ' + (
        kind === 'error'
          ? 'bg-red-50 text-red-900 border-red-200'
          : kind === 'success'
            ? 'bg-green-50 text-green-900 border-green-200'
            : 'bg-yellow-50 text-yellow-900 border-yellow-200'
      );
      setTimeout(()=> setStatus(''), 3500);
    }
    function fmtUSD(x) { return (x==null||isNaN(Number(x))) ? '—' : '$'+Number(x).toFixed(2); }
    function fmtEUR(x) { return (x==null||isNaN(Number(x))) ? '—' : '€'+Number(x).toFixed(2); }
    function todayISO() { return new Date().toISOString().slice(0,10); }
    function saveCreds(pid, pkey){ localStorage.setItem('pf_id',pid); localStorage.setItem('pf_key',pkey); $('#pid').value=pid; $('#pkey').value=pkey; }
    function loadCreds(){ const pid=localStorage.getItem('pf_id')||''; const pkey=localStorage.getItem('pf_key')||''; $('#pid').value=pid; $('#pkey').value=pkey; return {pid,pkey}; }
    async function fetchJSON(url, opts={}) { const r = await fetch(url, opts); if (!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); }

    // ----- TOP MOVERS -----
    async function loadMovers() {
      try {
        const movers = await fetchJSON(WORKER_BASE + '/api/movers?n=24');
        const grid = $('#movers');
        const empty = $('#moversEmpty');
        if (!Array.isArray(movers) || movers.length === 0) {
          grid.innerHTML = '';
          empty.classList.remove('hidden');
          return;
        }
        empty.classList.add('hidden');
        grid.innerHTML = movers.map(m => {
          const signal = (m.signal || '—').toString().toUpperCase();
          let badgeClass = 'badge-hold';
          if (signal === 'BUY')  badgeClass = 'badge-buy';
          if (signal === 'SELL') badgeClass = 'badge-sell';
          const price = (m.price_usd != null) ? fmtUSD(m.price_usd) : (m.price_eur != null ? fmtEUR(m.price_eur) : '—');
          const sub = m.ts7 != null ? `ts7 ${Number(m.ts7).toFixed(2)}` : `score ${Number(m.score || 0).toFixed(1)}`;
          return `
            <div class="border rounded bg-white p-2 cursor-pointer card-tile" data-cardid="${m.id}">
              <img src="${m.image_url||''}" class="w-full h-auto rounded" alt="">
              <div class="mt-2 text-sm font-medium leading-snug">${m.name}</div>
              <div class="text-xs text-gray-500">${m.set_name||''}</div>
              <div class="mt-1 flex items-center justify-between text-sm">
                <span>${price}</span>
                <span class="badge ${badgeClass}">${signal}</span>
              </div>
              <div class="text-xs text-gray-500">${sub}</div>
            </div>`;
        }).join('');

        grid.querySelectorAll('[data-cardid]').forEach(el => {
          el.addEventListener('click', () => openDetails(el.getAttribute('data-cardid')));
        });
      } catch (e) {
        console.error(e);
        setStatus('Failed to load movers: ' + e.message, 'error');
      }
    }

    // ----- TABLE (cards with signals; fallback to universe) -----
    async function loadCards() {
      try {
        const data = await fetchJSON(WORKER_BASE + '/api/cards');
        if (Array.isArray(data) && data.length) { renderCards(data); return; }
      } catch (_) {}
      const u = await fetchJSON(WORKER_BASE + '/api/universe');
      renderCards((u||[]).map(c => ({ ...c, signal:'—', score:'—' })));
    }

    function renderCards(data) {
      const tbody = $('#rows');
      if (!Array.isArray(data) || !data.length) {
        tbody.innerHTML = '<tr><td class="p-3 text-sm text-gray-600" colspan="7">No cards yet.</td></tr>';
        return;
      }
      const html = data.map(c => {
        const signal = (c.signal || '—').toString().toUpperCase();
        let badgeClass='badge-hold'; if (signal==='BUY') badgeClass='badge-buy'; if (signal==='SELL') badgeClass='badge-sell';
        const price = (c.price_usd != null) ? fmtUSD(c.price_usd) : (c.price_eur != null ? fmtEUR(c.price_eur) : '—');
        const score = (c.score == null || c.score === '—') ? '—' : Number(c.score).toFixed(1);
        return `
          <tr class="hover-row cursor-pointer" data-cardid="${c.id}">
            <td class="p-2">
              <div class="flex gap-2 items-center">
                <img src="${c.image_url||''}" alt="" class="w-12 h-auto rounded" />
                <div><div class="font-medium">${c.name}</div></div>
              </div>
            </td>
            <td class="p-2">${c.set_name||''}</td>
            <td class="p-2">${c.rarity||''}</td>
            <td class="p-2">${price}</td>
            <td class="p-2"><span class="badge ${badgeClass}">${signal}</span></td>
            <td class="p-2">${score}</td>
            <td class="p-2 text-xs text-gray-600">${c.id}</td>
          </tr>`;
      }).join('');
      tbody.innerHTML = html;
      tbody.querySelectorAll('tr[data-cardid]').forEach(tr => {
        tr.addEventListener('click', () => {
          const id = tr.getAttribute('data-cardid');
          $('#lotCard').value = id || '';
          openDetails(id);
        });
      });
    }

    // ----- Portfolio actions -----
    $('#btnReload').addEventListener('click', async () => { await Promise.all([loadMovers(), loadCards()]); });

    $('#sub').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('#email').value.trim(); if (!email) return;
      try {
        const r = await fetch(WORKER_BASE + '/api/subscribe', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ email }) });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        setStatus('Subscribed! You’ll get an email when signals change.', 'success'); $('#email').value='';
      } catch (e) { setStatus('Subscription failed: ' + e.message, 'error'); }
    });

    $('#btnCreate').addEventListener('click', async () => {
      try {
        const r = await fetch(WORKER_BASE + '/portfolio/create', { method: 'POST' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json(); if (j.id && j.secret) { saveCreds(j.id, j.secret); setStatus('Portfolio created and saved.', 'success'); }
        else throw new Error('No id/secret returned.');
      } catch (e) { setStatus('Create portfolio failed: ' + e.message, 'error'); }
    });

    $('#btnSaveCreds').addEventListener('click', () => {
      const pid = $('#pid').value.trim(), pkey = $('#pkey').value.trim();
      if (!pid || !pkey) { setStatus('Enter both Portfolio ID and Secret.', 'error'); return; }
      saveCreds(pid, pkey); setStatus('Credentials saved to this browser.', 'success');
    });

    $('#btnAddLot').addEventListener('click', async () => {
      const pid=$('#pid').value.trim(), pkey=$('#pkey').value.trim(), card=$('#lotCard').value.trim();
      const qty=Number($('#lotQty').value), cost=Number($('#lotCost').value), date=$('#lotDate').value || todayISO();
      if (!pid || !pkey) return setStatus('Save portfolio credentials first.', 'error');
      if (!card || !(qty>0) || !(cost>=0)) return setStatus('Invalid lot fields.', 'error');
      try {
        const r = await fetch(WORKER_BASE + '/portfolio/add-lot', {
          method:'POST',
          headers:{'content-type':'application/json','x-portfolio-id':pid,'x-portfolio-secret':pkey},
          body: JSON.stringify({ card_id: card, qty, cost_usd: cost, acquired_at: date })
        });
        const j = await r.json(); if (!r.ok || !j.ok) throw new Error(j.error || ('HTTP '+r.status));
        setStatus('Lot added.', 'success'); $('#btnLoadPnL').click();
      } catch (e) { setStatus('Add lot failed: ' + e.message, 'error'); }
    });

    $('#btnLoadPnL').addEventListener('click', async () => {
      const pid=$('#pid').value.trim(), pkey=$('#pkey').value.trim();
      if (!pid || !pkey) return setStatus('Save portfolio credentials first.', 'error');
      try {
        const r = await fetch(WORKER_BASE + '/portfolio', { headers:{'x-portfolio-id':pid,'x-portfolio-secret':pkey} });
        const j = await r.json(); if (!r.ok || !j.ok) throw new Error(j.error || ('HTTP '+r.status));
        const rows = j.rows || [], totals = j.totals || {}; const pnl = $('#pnl');
        pnl.innerHTML = `
          <div class="mb-2"><b>Totals:</b>
            Cost <b>${fmtUSD(totals.cost_usd)}</b>,
            Mkt <b>${fmtUSD(totals.market_value_usd)}</b>,
            P&L <b>${fmtUSD(totals.pnl_usd)}</b>
            ${totals.roi_pct != null ? ' (' + Number(totals.roi_pct).toFixed(2) + '%)' : '' }
          </div>
          <div class="overflow-auto border rounded bg-white">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gray-100 text-left text-sm">
                  <th class="p-2">Card</th><th class="p-2">Qty</th><th class="p-2">Cost (USD)</th>
                  <th class="p-2">Price</th><th class="p-2">Market Value (USD)</th><th class="p-2">P&L (USD)</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => `
                  <tr class="border-t">
                    <td class="p-2">
                      <div class="flex gap-2 items-center">
                        <img src="${r.image_url||''}" class="w-10 h-auto rounded"/>
                        <div><div class="font-medium">${r.name}</div><div class="text-gray-500 text-xs">${r.set_name||''}</div></div>
                      </div>
                    </td>
                    <td class="p-2">${r.qty ?? '—'}</td>
                    <td class="p-2">${fmtUSD(r.cost_usd)}</td>
                    <td class="p-2">
                      ${r.price_usd != null ? fmtUSD(r.price_usd) : (r.price_eur != null ? fmtEUR(r.price_eur) : '—')}
                      <span class="text-gray-500 text-xs">${r.price_as_of || ''}</span>
                    </td>
                    <td class="p-2">${r.market_value_usd != null ? fmtUSD(r.market_value_usd) : '—'}</td>
                    <td class="p-2 ${r.pnl_usd>0?'text-green-700':(r.pnl_usd<0?'text-red-700':'')}">
                      ${r.pnl_usd != null ? fmtUSD(r.pnl_usd) : '—'}
                    </td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        setStatus('P&L updated.', 'success');
      } catch (e) { console.error(e); setStatus('Load P&L failed: ' + e.message, 'error'); }
    });

    // ----- Modal & Details -----
    function sparklineSVG(values, { width=560, height=70, pad=4 } = {}) {
      if (!Array.isArray(values) || values.length < 2) return `<svg width="${width}" height="${height}"></svg>`;
      const w=width,h=height,p=pad,n=values.length;
      const xs = values.map((_,i)=>p + (i*(w-2*p))/(n-1));
      const finite = values.filter(v=>Number.isFinite(v)); const min=Math.min(...finite), max=Math.max(...finite), rng=(max-min)||1e-9;
      const ys = values.map(v => (h-p) - ((v-min)/rng)*(h-2*p));
      const stroke = values[values.length-1] >= values[0] ? '#065f46' : '#991b1b';
      return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
                <polyline fill="none" stroke="${stroke}" stroke-width="2" points="${xs.map((x,i)=>`${x},${ys[i]}`).join(' ')}" />
              </svg>`;
    }

    async function openDetails(cardId) {
      try {
        const data = await fetchJSON(WORKER_BASE + '/api/card?id=' + encodeURIComponent(cardId));
        if (!data?.ok) throw new Error('No data');
        $('#mImage').src = data.card?.image_url || '';
        $('#mTitle').textContent = `${data.card?.name || cardId}`;
        $('#mMeta').textContent  = `${data.card?.set_name || ''} • ${data.card?.rarity || ''}`;
        $('#mCsv').href = WORKER_BASE + '/research/card-csv?id=' + encodeURIComponent(cardId) + '&days=120';

        const priceValues = (data.prices || []).map(r => (r.usd != null ? Number(r.usd) : (r.eur != null ? Number(r.eur) : NaN))).filter(Number.isFinite);
        $('#mPriceSpark').innerHTML = sparklineSVG(priceValues, { width: 600, height: 80, pad: 6 });

        const scoreValues = (data.signals || []).map(r => r.score != null ? Number(r.score) : NaN).filter(Number.isFinite);
        $('#mScoreSpark').innerHTML = scoreValues.length ? sparklineSVG(scoreValues, { width: 600, height: 80, pad: 6 }) : '<div class="text-xs text-gray-500 p-2">No scores yet.</div>';

        const modal = $('#cardModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
      } catch (e) { console.error(e); setStatus('Failed to load details: ' + e.message, 'error'); }
    }

    $('#modalClose').addEventListener('click', () => {
      const modal = $('#cardModal'); modal.classList.add('hidden'); modal.classList.remove('flex');
    });
    $('#cardModal').addEventListener('click', (e) => { if (e.target === $('#cardModal')) $('#modalClose').click(); });

    // ----- Boot -----
    (async function boot(){
      $('#lotDate').value = todayISO();
      loadCreds();
      setStatus('Loading…');
      await Promise.all([loadMovers(), loadCards()]);
      setStatus('Ready', 'success');
    })();
  </script>

  <!-- Card Details Modal -->
  <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white max-w-2xl w-full rounded shadow-lg p-4 relative">
      <button id="modalClose" class="absolute right-2 top-2 text-gray-500 hover:text-black">✕</button>
      <div class="flex gap-4">
        <img id="mImage" src="" alt="" class="w-32 h-auto rounded border">
        <div>
          <h3 id="mTitle" class="text-lg font-semibold"></h3>
          <div id="mMeta" class="text-sm text-gray-600"></div>
          <div class="mt-2">
            <a id="mCsv" href="#" class="text-sm underline" target="_blank" rel="noreferrer">Download CSV (last 120d)</a>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <h4 class="font-semibold mb-1 text-sm">Price (USD if available)</h4>
        <div id="mPriceSpark" class="w-full h-20 border rounded p-1 bg-gray-50"></div>
      </div>
      <div class="mt-4">
        <h4 class="font-semibold mb-1 text-sm">Score</h4>
        <div id="mScoreSpark" class="w-full h-20 border rounded p-1 bg-gray-50"></div>
      </div>
    </div>
  </div>
</body>
</html>
