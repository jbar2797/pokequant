# Email Domain Authentication & Delivery Readiness

Status: Draft

## Purpose
Document the steps to fully enable real email sending with authenticated domain for improved deliverability and to transition from simulation to production mode.

## Provider
Resend (Decision 0005). Real sending gated by environment variable `EMAIL_REAL_SEND=1` AND presence of a non-test `RESEND_API_KEY`.

## DNS Records (Example)
Replace `example.com` with the real sending domain.

| Type | Name | Value | Purpose |
|------|------|-------|---------|
| TXT  | resend._domainkey.example.com | k=rsa; p=BASE64PUBLICKEY | DKIM key (generated by provider) |
| TXT  | example.com | v=spf1 include:spf.resend.com -all | SPF authorize resend | 
| TXT  | _dmarc.example.com | v=DMARC1; p=none; rua=mailto:dmarc-reports@example.com; fo=1 | DMARC aggregate (start p=none, tighten later) |

(Exact hostnames/values will come from provider dashboard – copy verbatim.)

## Steps
1. Add DNS records (SPF, DKIM, optional DMARC) in Cloudflare dashboard.
2. Wait for propagation; verify in Resend dashboard until status = verified.
3. Set `RESEND_API_KEY` secret (non-test) in Wrangler environment.
4. Deploy with `EMAIL_REAL_SEND=0` initially (dry configuration) – confirm diagnostics: `/admin/diagnostics/integrations` reflects real key but simulation false until you flip flag.
5. Flip `EMAIL_REAL_SEND=1` and redeploy; monitor metrics:
   - `email.sent.real` increments (vs `.sim`).
   - `email.send_error.real` remains near zero.
6. Configure provider webhooks (bounce, complaint, delivered) pointing to:
   - `/webhooks/email/bounce` (shared secret optional future) – already normalizing events.
   - `/webhooks/email/delivered` with HTTP header `x-email-webhook-secret: <secret>` (set `EMAIL_WEBHOOK_SECRET`).
7. Verify delivered events increment `email.delivered` and appear in admin deliveries view.
8. Update readiness score (Delivery Integrations) once domain verified + real send stable 7 days.

## Rollback Plan
If deliverability issues or elevated error rates:
- Set `EMAIL_REAL_SEND=0` and redeploy (simulation resumes; messages not actually sent).
- Keep webhooks active; simulation path won't produce new delivered events—note metric interpretation gap.

## Monitoring
Key metrics & thresholds:
- `email.success_ratio` (internal gauge) > 0.95.
- Bounce rate (`email.event.bounce` / `email.sent.real`) < 2%.
- Complaint rate (`email.event.complaint` / `email.sent.real`) < 0.2%.

Alert if:
- Success ratio < 0.90 over 15m window.
- Bounce or complaint rate doubles week-over-week.

## Provider Error Taxonomy (Planned Mapping)
| Provider Code | Category | Internal Error Code | Action |
|---------------|----------|---------------------|--------|
| rate_limited  | transient | email_provider_rate_limited | Backoff & retry |
| invalid_email | permanent | email_invalid_recipient | Drop + log |
| policy_block  | permanent | email_policy_block | Drop + log |
| timeout       | transient | email_provider_timeout | Retry up to 3x |

(Expand after collecting live samples.)

## Security
- Store `RESEND_API_KEY` as secret (never logged).
- Delivered webhook protected by `EMAIL_WEBHOOK_SECRET` shared secret header.
- Rotate webhook secret quarterly; update provider configuration and redeploy – schedule documented in runbook.

## Open Items
- Automate secret rotation helper script.
- Add provider bounce / complaint classification expansion.
- Implement per-email message_id lookup endpoint (admin) for troubleshooting.

---
Update this doc when DNS verified, taxonomy expanded, or rotation automation added.
